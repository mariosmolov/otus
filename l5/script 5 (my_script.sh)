#!/bin/bash
# Переменные.
d="$(date +%d.%m.%Y)" # Определение даты
t="$(date +%H:%M)" # Определение времениe
exclude=/home/user/backup/exclude_formats
logf=/home/user/files_backup.log

echo "" >> $logf
echo "========================================================================" >> $logf # Добавляем разделитель
echo "Копирование начато:" >> $logf # Добавляем перенос
echo "$d $t" >> $logf # Вставляем дату и время
echo "" >> $logf # Добавляем перенос

# Функция запуска rsync
function rsyncf() {
local lsrc="$1"
local ldst="$2"
    echo "..........................................." >> $logf # Добавляем разделитель
    echo "$(date +%d.%m.%Y) $(date +%H:%M)" >> $logf # Вставляем дату и время
    echo "Папка источник: $lsrc" >> $logf
    echo "Папка назначения: $ldst" >> $logf
    echo "Папка архивов: $lbkp" >> $logf
    echo "" >> $logf
    # Выполняем копирование рекурсивно, с сохранением временных меток, загружая только обновленные файлы,
    # архивные версии файлов помещая в папку $bkp/$dt, записывая статистику в файл лога
    rsync -rtu --exclude-from="$exclude" --ignore-errors --stats --delete --force --delete-excluded --timeout=300  "$lsrc" "$ldst" >> $logf

    echo "" >> $logf # Добавляем перенос
    echo "Копирование завершено:" >> $logf # Добавляем перенос
    echo "$(date +%d.%m.%Y) $(date +%H:%M)" >> $logf # Вставляем дату и время
    echo "..........................................." >> $logf # Добавляем разделитель
}
# Конец функции

# Функция проверки существования папки источника ($src)
function chk_source() {
local lsrc="$1" # Путь к папке источнику
local ldst="$2" # Путь к папке назначения

if [[ -d "$lsrc" && "$(ls -A $lsrc)" ]] ; then
rsyncf "$lsrc" "$ldst" # Вызываем функцию копирования
else
echo "$d $t Ошибка. Папка-источник пуста или не существует ($lsrc)" >> $logf
exit 1
fi
}
# Конец функции проверки существования папки источника

# !!!!!!!!!! Вызов функции проверки доступности источника и запуска резервного копирования

chk_source "/mnt/net/net_files/" "/mnt/bkp_pool/files/" # Вызываем функцию проверки источника

# !!!!!!!!!! Завершение вызова функции.

#echo "" >> $logf # Добавляем перенос
#echo "Копирование завершено:" >> $logf # Добавляем перенос
#echo "$(date +%d.%m.%Y) $(date +%H:%M)" >> $logf # Вставляем дату и время
echo "========================================================================" >> $logf # Добавляем разделитель
echo "" >> $logf

exit 0
