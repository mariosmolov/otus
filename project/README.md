# Простой отказоустойчивый кластер с Wordpress, на базе pacemaker и corosync.

## Как запустить
```
vagrant up
ansible-playbook ./cluster.yml
```
Для доступа к Web-интерфейсу Wordpress необходимо использовать URL http://192.168.0.100/wordpress

## Описание

Узлы кластера:
* proxy1 - входной узел, балансировщик трафика на web1 и web2
* proxy2 - резервный входной узел, балансировщик трафика на web1 и web2 (находится в состоянии горячего резерва)
* web1 - web-сервер
* web2 - web-сервер
* db1 - сервер баз данных, отвечает на запросы к БД
* db2 - резервный сервер баз данных, содержит копию БД db1 (находится в состоянии горячего резерва)
* logger - сервер сбора логов, принимает информацию о события от proxy-, web- и db-серверов (только error, emerg, crit).
* backup - сервер резервного копирования, использует bacula, осуществляет управление резервным копирование proxy-, web- и db-серверов.

При развертывании стенда ВМ имеют следующие IP-адреса:
* proxy1 - 192.168.1.1/24 (вн.), 192.168.0.1/24 (внеш.), 192.168.0.100/24 (VIP внеш.)
* proxy2 - 192.168.1.2/24 (вн.), 192.168.0.2/24 (внеш.)
* web1 - 192.168.1.11/24 (вн.)
* web2 - 192.168.1.12/24 (вн.)
* db1 - 192.168.1.21/24 (вн.), 192.168.1.20/32 (вн.)
* db2 - 192.168.1.22/24 (вн.)
* logger - 192.168.1.51/24 (вн.)
* backup - 192.168.1.52/24 (вн.)

Для управления кластером используется ПО **pacemaker + corosync.**
Узлы proxy*, web*, db* являются членами кластера. Для узлов proxy* и db* создаются виртуальные IP-адреса. Proxy VIP-адрес используется для доступа к Web-серверам. В случае отказа proxy1 этот IP-адрес будет установлен на узле proxy2. DB VIP-адрес нужен для указания мастер-сервера баз данных. Аналогично proxy VIP, в случае отказа db1, этот адрес будет установлен на db2. 

Для синхронизации данных между web-серверми используется rsync + lsync, который отслеживает изменения в каталоге web-сервера, и, в случае их обнаружения, запускает синхронизацию. В данном случае может наблюдаться ситуация, когда при загрузке файлов на сервер, при обновлении страницы, сервером будет отдана страница без загруженного файла. Это связано с тем, что синхронизация каталогов таким способом занимает значительное время - несколько секунд, а, так как на пути трафика есть балансировщик нагрузки, ответ может поступить от сервера, на котором данный файл еще не появился. Разрешить данную ситуацию можно изменив настройки балансировщика так, чтобы балансировка производилась в зависимости от адреса источника.

СУБД на серверах баз данных настроены как мастер - мастер, таким образом изменения произошедшие на одном сервера тут же реплицируются на второй сервер.
